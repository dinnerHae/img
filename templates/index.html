<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì´ë¯¸ì§€ ZIP ë‹¤ìš´ë¡œë”</title>
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='icon-192.png') }}">
  <meta name="theme-color" content="#000000" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; background: #f5f5f5; color: #333; }
    .container { max-width: 560px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size: 24px; text-align: center; margin-bottom: 12px; }
    .desc { color:#666; font-size: 14px; text-align:center; margin-bottom: 16px; }
    label { display:block; margin-top: 10px; font-weight: bold; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 60px; }
    .task { background:#fafafa; border:1px solid #e5e5e5; border-radius:10px; padding:12px; margin-top:14px; }
    .actions { display:flex; gap:8px; margin-top:14px; }
    button { padding: 12px 14px; background:#007bff; color:#fff; font-weight:600; border:none; border-radius:8px; cursor:pointer; }
    button.secondary { background:#555; }
    button.danger { background:#c0392b; }
    button:hover { filter:brightness(0.95); }
    #progress-container { margin-top: 20px; display:none; }
    progress { width: 100%; height: 24px; }
    #progress-text { text-align:center; margin-top:8px; }
    .download-list { margin-top:16px; }
    .download-list a { display:block; margin:6px 0; text-decoration:none; font-weight:600; color:#007bff; }
    .download-list a:hover { text-decoration:underline; }
    .hint { font-size:12px; color:#888; margin-top:6px; }
    .error { color:#b00020; margin-top:10px; font-size:13px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì´ë¯¸ì§€ ZIP ë‹¤ìš´ë¡œë”</h1>
    <p class="desc">ZIP íŒŒì¼ëª… ì§ì ‘ ì§€ì • + ë™ì‹œ ë‹¤ìš´ë¡œë“œ ê°œìˆ˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <form id="download-form">
      <label>ë™ì‹œ ë‹¤ìš´ë¡œë“œ ê°œìˆ˜ (1~20, ê¸°ë³¸ 5)</label>
      <input type="number" name="max_workers" value="5" min="1" max="20" />

      <div id="tasks">
        <div class="task">
          <div class="task-title" style="font-weight:700;">1ë²ˆ ì‘ì—…</div>
          <label>ì‚¬ì´íŠ¸ ì£¼ì†Œ í˜•ì‹ (ì˜ˆ: https://example.com/img_###.jpg)</label>
          <input type="text" name="url_format[]" required />
          <label>ì‹œì‘ ìˆ«ì</label>
          <input type="number" name="start[]" />
          <label>ë ìˆ«ì</label>
          <input type="number" name="end[]" />
          <label>ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ (ì„ íƒ: í•œ ì¤„ì— í•œ ë‹¨ì–´ì”©)</label>
          <textarea name="wordlist[]" placeholder="ì˜ˆ: ë°”ë‚˜ë‚˜&#10;ì‚¬ê³¼"></textarea>
          <label>Referer (ì„ íƒ)</label>
          <input type="text" name="referer[]" placeholder="ì˜ˆ: https://example.com/viewer" />
          <label>Cookie (ì„ íƒ)</label>
          <input type="text" name="cookie[]" placeholder="ì˜ˆ: sessionid=12345; token=abcd" />
          <div class="hint">â€» ìˆ«ì ë²”ìœ„(start~end), ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸, Referer/CookieëŠ” í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</div>
          <label>ZIP íŒŒì¼ëª… (ì„ íƒ, ì˜ˆ: mypics)</label>
          <input type="text" name="zipname[]" placeholder="ë¹„ì›Œë‘ë©´ result_taskN.zip, .zipì€ ìë™ìœ¼ë¡œ ë¶™ìŒ" />
          <div class="actions"><button type="button" class="danger remove-btn" style="display:none;">- ì œê±°</button></div>
        </div>
      </div>
      <div class="actions">
        <button type="button" id="add-btn">+ ì‘ì—… ì¶”ê°€</button>
        <button type="submit">ë‹¤ìš´ë¡œë“œ ì‹œì‘</button>
      </div>
      <div class="hint">â€» ì£¼ì†ŒëŠ” ë°˜ë“œì‹œ ### ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</div>
      <div id="error" class="error"></div>

      <hr style="margin:30px 0;">
      <h3>ğŸŒ ë‹¤ì¤‘ ì£¼ì†Œ ë‹¤ìš´ë¡œë“œ (ê° ì‚¬ì´íŠ¸ë³„ í´ë” ìƒì„±)</h3>
      <label>ì£¼ì†Œ ì—¬ëŸ¬ ê°œ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
      <textarea name="multi_urls" placeholder="ì˜ˆ: https://a.com/img###.jpg, https://b.com/path/file###.png"></textarea>
      <label>ì‹œì‘ ìˆ«ì</label>
      <input type="number" name="multi_start" />
      <label>ë ìˆ«ì</label>
      <input type="number" name="multi_end" />
      <label>Referer (ì„ íƒ)</label>
      <input type="text" name="multi_referer" placeholder="ì˜ˆ: https://example.com/viewer" />
      <label>Cookie (ì„ íƒ)</label>
      <input type="text" name="multi_cookie" placeholder="ì˜ˆ: sessionid=12345; token=abcd" />
      <label>ZIP íŒŒì¼ëª… (ì„ íƒ)</label>
      <input type="text" name="multi_zipname" placeholder="ì˜ˆ: multi_sites.zip" />
      <div class="hint">â€» ë‹¤ì¤‘ ì£¼ì†Œê°€ ì…ë ¥ë˜ë©´ ZIP ë‚´ë¶€ì— ê° ë„ë©”ì¸ë³„ í´ë”ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      <div class="actions" style="margin-top:16px;">
        <button type="submit" style="background:#28a745;">ë‹¤ì¤‘ ì£¼ì†Œ ë‹¤ìš´ë¡œë“œ ì‹œì‘</button>
      </div>
    </form>

    <div id="progress-container">
      <progress id="progress-bar" value="0" max="100"></progress>
      <p id="progress-text">0%</p>
    </div>

    <div class="download-list" id="download-list" style="display:none;"></div>
  </div>

  <script>
    (function(){
      var tasksEl = document.getElementById('tasks');
      var addBtn = document.getElementById('add-btn');
      var form = document.getElementById('download-form');
      var progressContainer = document.getElementById('progress-container');
      var progressBar = document.getElementById('progress-bar');
      var progressText = document.getElementById('progress-text');
      var downloadList = document.getElementById('download-list');
      var errorBox = document.getElementById('error');

      function renumberTasks() {
        var cards = tasksEl.getElementsByClassName('task');
        for (var i = 0; i < cards.length; i++) {
          var title = cards[i].getElementsByClassName('task-title')[0];
          if (title) title.textContent = (i+1) + 'ë²ˆ ì‘ì—…';
          var removeBtn = cards[i].getElementsByClassName('remove-btn')[0];
          if (removeBtn) removeBtn.style.display = (i === 0 ? 'none' : 'inline-block');
        }
      }

      function makeTaskCard() {
        var div = document.createElement('div');
        div.className = 'task';
        div.innerHTML =
          '<div class="task-title" style="font-weight:700;"></div>' +
          '<label>ì‚¬ì´íŠ¸ ì£¼ì†Œ í˜•ì‹ (ì˜ˆ: https://example.com/img_###.jpg)</label>' +
          '<input type="text" name="url_format[]" required />' +
          '<label>ì‹œì‘ ìˆ«ì</label>' +
          '<input type="number" name="start[]" />' +
          '<label>ë ìˆ«ì</label>' +
          '<input type="number" name="end[]" />' +
          '<label>ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ (ì„ íƒ: í•œ ì¤„ì— í•œ ë‹¨ì–´ì”©)</label>' +
          '<textarea name="wordlist[]" placeholder="ì˜ˆ: ë°”ë‚˜ë‚˜&#10;ì‚¬ê³¼"></textarea>' +
          '<label>Referer (ì„ íƒ)</label>' +
          '<input type="text" name="referer[]" placeholder="ì˜ˆ: https://example.com/viewer" />' +
          '<label>Cookie (ì„ íƒ)</label>' +
          '<input type="text" name="cookie[]" placeholder="ì˜ˆ: sessionid=12345; token=abcd" />' +
          '<div class="hint">â€» ìˆ«ì ë²”ìœ„(start~end), ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸, Referer/CookieëŠ” í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</div>' +
          '<label>ZIP íŒŒì¼ëª… (ì„ íƒ, ì˜ˆ: mypics)</label>' +
          '<input type="text" name="zipname[]" placeholder="ë¹„ì›Œë‘ë©´ result_taskN.zip, .zipì€ ìë™ìœ¼ë¡œ ë¶™ìŒ" />' +
          '<div class="actions"><button type="button" class="danger remove-btn">- ì œê±°</button></div>';
        return div;
      }

      addBtn.addEventListener('click', function(){
        tasksEl.appendChild(makeTaskCard());
        renumberTasks();
      });

      tasksEl.addEventListener('click', function(e){
        var t = e.target || e.srcElement;
        if (t && t.classList.contains('remove-btn')) {
          var card = t.closest('.task');
          if (card) {
            card.parentNode.removeChild(card);
            renumberTasks();
          }
        }
      });

      function startProgressPolling() {
        function poll(){
          fetch('/progress')
            .then(function(res){ return res.json(); })
            .then(function(data){
              progressBar.value = data.percent || 0;
              progressText.textContent = (data.percent || 0) + '%';
              if ((data.percent || 0) < 100) {
                setTimeout(poll, 700);
              } else {
                fetch('/expected-zips')
                  .then(function(r){ return r.json(); })
                  .then(function(j){
                    var zips = j.zips || [];
                    downloadList.style.display = 'block';
                    var html = '<p>âœ… ì‘ì—… ì™„ë£Œ! ZIP íŒŒì¼ì„ ë‚´ë ¤ë°›ìœ¼ì„¸ìš”.</p>';
                    if (!zips.length) {
                      html += '<p>ìƒì„±ëœ ZIPì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    } else {
                      for (var i = 0; i < zips.length; i++) {
                        var href = '/static/' + zips[i];
                        html += '<a href="' + href + '" download>' + zips[i] + ' ë‹¤ìš´ë¡œë“œ</a>';
                      }
                    }
                    downloadList.innerHTML = html;
                    progressText.textContent = 'âœ… ì™„ë£Œ!';
                  });
              }
            })
            .catch(function(err){
              console.error(err);
              setTimeout(poll, 1000);
            });
        }
        setTimeout(poll, 700);
      }

      form.addEventListener('submit', function(e){
        e.preventDefault();
        errorBox.style.display = 'none';
        progressContainer.style.display = 'block';
        progressBar.value = 0;
        progressText.textContent = '0%';
        downloadList.style.display = 'none';
        var formData = new FormData(form);
        fetch('/start-download', { method: 'POST', body: formData })
          .then(function(res){
            if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
            startProgressPolling();
          })
          .catch(function(err){
            errorBox.style.display = 'block';
            errorBox.textContent = 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + (err && err.message ? err.message : err);
            console.error(err);
          });
      });

      renumberTasks();
    })();
  </script>
</body>
</html>
